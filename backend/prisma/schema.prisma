generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  avatar       String?
  bio          String?   @db.Text
  role         String    @default("admin")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  articles     Article[]

  @@map("users")
}

model Category {
  id           Int                   @id @default(autoincrement())
  slug         String                @unique
  image        String?
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")
  translations CategoryTranslation[]
  articles     Article[]

  @@map("categories")
}

model CategoryTranslation {
  id          Int      @id @default(autoincrement())
  categoryId  Int      @map("category_id")
  lang        String   @db.VarChar(2)
  name        String
  description String?  @db.Text
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, lang])
  @@map("category_translations")
}

model Tag {
  id           Int              @id @default(autoincrement())
  slug         String           @unique
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  translations TagTranslation[]
  articles     ArticleTag[]

  @@map("tags")
}

model TagTranslation {
  id    Int    @id @default(autoincrement())
  tagId Int    @map("tag_id")
  lang  String @db.VarChar(2)
  name  String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, lang])
  @@map("tag_translations")
}

model Dossier {
  id           Int                  @id @default(autoincrement())
  slug         String               @unique
  heroImage    String?              @map("hero_image")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  translations DossierTranslation[]
  articles     ArticleDossier[]

  @@map("dossiers")
}

model DossierTranslation {
  id          Int     @id @default(autoincrement())
  dossierId   Int     @map("dossier_id")
  lang        String  @db.VarChar(2)
  title       String
  description String? @db.Text
  dossier     Dossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@unique([dossierId, lang])
  @@map("dossier_translations")
}

model Article {
  id             Int                  @id @default(autoincrement())
  slug           String               @unique
  categoryId     Int                  @map("category_id")
  authorId       Int                  @map("author_id")
  heroImage      String?              @map("hero_image")
  featured       Boolean              @default(false)
  views          Int                  @default(0)
  readingMinutes Int                  @default(5) @map("reading_minutes")
  publishedAt    DateTime?            @map("published_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  youtubeUrl     String?              @map("youtube_url")
  category       Category             @relation(fields: [categoryId], references: [id])
  author         User                 @relation(fields: [authorId], references: [id])
  translations   ArticleTranslation[]
  tags           ArticleTag[]
  dossiers       ArticleDossier[]
  personnalites  Personnalite[]
  comments       Comment[]

  @@map("articles")
}

model ArticleTranslation {
  id          Int     @id @default(autoincrement())
  articleId   Int     @map("article_id")
  lang        String  @db.VarChar(2)
  title       String
  excerpt     String? @db.Text
  contentHtml String? @db.LongText @map("content_html")
  takeaway    String? @db.Text
  sources     String? @db.Text
  article     Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, lang])
  @@map("article_translations")
}

model ArticleTag {
  articleId Int     @map("article_id")
  tagId     Int     @map("tag_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

model ArticleDossier {
  articleId Int     @map("article_id")
  dossierId Int     @map("dossier_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  dossier   Dossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@id([articleId, dossierId])
  @@map("article_dossiers")
}

model CategoriePersonnalite {
  id            Int                              @id @default(autoincrement())
  slug          String                           @unique
  image         String?
  createdAt     DateTime                         @default(now()) @map("created_at")
  updatedAt     DateTime                         @updatedAt @map("updated_at")
  translations  CategoriePersonnaliteTranslation[]
  personnalites PersonnaliteCategory[]

  @@map("categories_personnalites")
}

model CategoriePersonnaliteTranslation {
  id          Int                   @id @default(autoincrement())
  categorieId Int                   @map("categorie_id")
  lang        String                @db.VarChar(2)
  nom         String
  description String                @db.Text
  categorie   CategoriePersonnalite @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  @@unique([categorieId, lang])
  @@map("categories_personnalites_translations")
}

model Personnalite {
  id          Int                    @id @default(autoincrement())
  slug        String                 @unique
  nom         String
  image       String?
  youtubeUrl  String?                @map("youtube_url")
  articleId   Int?                   @map("article_id")
  publishedAt DateTime?              @map("published_at")
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")
  article     Article?               @relation(fields: [articleId], references: [id], onDelete: SetNull)
  categories  PersonnaliteCategory[]

  @@map("personnalites")
}

model PersonnaliteCategory {
  personnaliteId Int                   @map("personnalite_id")
  categorieId    Int                   @map("categorie_id")
  personnalite   Personnalite          @relation(fields: [personnaliteId], references: [id], onDelete: Cascade)
  categorie      CategoriePersonnalite @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  @@id([personnaliteId, categorieId])
  @@map("personnalite_categories")
}

model Redirect {
  id         Int      @id @default(autoincrement())
  oldPath    String   @unique @map("old_path") @db.VarChar(500)
  newPath    String   @map("new_path") @db.VarChar(500)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   Int      @map("entity_id")
  hits       Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("redirects")
}

// Table contacts - source unique pour tous les emails
model Contact {
  id                 Int       @id @default(autoincrement())
  email              String    @unique @db.VarChar(255)
  name               String?   @db.VarChar(100)
  isSubscriber       Boolean   @default(false) @map("is_subscriber")
  subscribedAt       DateTime? @map("subscribed_at")
  subscriptionSource String?   @map("subscription_source") @db.VarChar(50)
  subscriptionStatus String?   @map("subscription_status") @db.VarChar(20)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  comments           Comment[]

  @@map("contacts")
}

// DEPRECATED - Utiliser Contact à la place
// Gardé temporairement pour la rétrocompatibilité
// Table centrale pour tous les contacts (emails unifiés)
model Contact {
  id                 Int       @id @default(autoincrement())
  email              String    @unique @db.VarChar(255)
  name               String?   @db.VarChar(100)
  isSubscriber       Boolean   @default(false) @map("is_subscriber")
  subscribedAt       DateTime? @map("subscribed_at")
  subscriptionSource String?   @map("subscription_source") @db.VarChar(50)
  subscriptionStatus String?   @default("pending") @map("subscription_status") @db.VarChar(20)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  comments           Comment[]

  @@map("contacts")
}

// DEPRECATED: Garder pour rétrocompatibilité, sera supprimé plus tard
model Subscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  source    String?  @db.VarChar(50)
  status    String   @default("pending") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("subscribers")
}
model Comment {
  id          Int      @id @default(autoincrement())
  articleId   Int      @map("article_id")
  contactId   Int?     @map("contact_id")
  authorName  String   @map("author_name") @db.VarChar(100)
  authorEmail String   @map("author_email") @db.VarChar(255)
  content     String   @db.Text
  status      String   @default("pending") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at")
  article     Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@map("comments")
}
