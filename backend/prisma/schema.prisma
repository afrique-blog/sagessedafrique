generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String
  avatar       String?
  bio          String?   @db.Text
  role         String    @default("admin")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  articles     Article[]

  @@map("users")
}

model Category {
  id           Int                   @id @default(autoincrement())
  slug         String                @unique
  image        String?
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")
  translations CategoryTranslation[]
  articles     Article[]

  @@map("categories")
}

model CategoryTranslation {
  id          Int      @id @default(autoincrement())
  categoryId  Int      @map("category_id")
  lang        String   @db.VarChar(2)
  name        String
  description String?  @db.Text
  category    Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, lang])
  @@map("category_translations")
}

model Tag {
  id           Int              @id @default(autoincrement())
  slug         String           @unique
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  translations TagTranslation[]
  articles     ArticleTag[]

  @@map("tags")
}

model TagTranslation {
  id    Int    @id @default(autoincrement())
  tagId Int    @map("tag_id")
  lang  String @db.VarChar(2)
  name  String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, lang])
  @@map("tag_translations")
}

model Dossier {
  id           Int                  @id @default(autoincrement())
  slug         String               @unique
  heroImage    String?              @map("hero_image")
  createdAt    DateTime             @default(now()) @map("created_at")
  updatedAt    DateTime             @updatedAt @map("updated_at")
  translations DossierTranslation[]
  articles     ArticleDossier[]

  @@map("dossiers")
}

model DossierTranslation {
  id          Int     @id @default(autoincrement())
  dossierId   Int     @map("dossier_id")
  lang        String  @db.VarChar(2)
  title       String
  description String? @db.Text
  dossier     Dossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@unique([dossierId, lang])
  @@map("dossier_translations")
}

model Article {
  id             Int                  @id @default(autoincrement())
  slug           String               @unique
  categoryId     Int                  @map("category_id")
  authorId       Int                  @map("author_id")
  heroImage      String?              @map("hero_image")
  featured       Boolean              @default(false)
  views          Int                  @default(0)
  readingMinutes Int                  @default(5) @map("reading_minutes")
  publishedAt    DateTime?            @map("published_at")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  youtubeUrl     String?              @map("youtube_url")
  category       Category             @relation(fields: [categoryId], references: [id])
  author         User                 @relation(fields: [authorId], references: [id])
  translations   ArticleTranslation[]
  tags           ArticleTag[]
  dossiers       ArticleDossier[]
  personnalites  Personnalite[]
  comments       Comment[]

  @@map("articles")
}

model ArticleTranslation {
  id          Int     @id @default(autoincrement())
  articleId   Int     @map("article_id")
  lang        String  @db.VarChar(2)
  title       String
  excerpt     String? @db.Text
  contentHtml String? @db.LongText @map("content_html")
  takeaway    String? @db.Text
  sources     String? @db.Text
  article     Article @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([articleId, lang])
  @@map("article_translations")
}

model ArticleTag {
  articleId Int     @map("article_id")
  tagId     Int     @map("tag_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([articleId, tagId])
  @@map("article_tags")
}

model ArticleDossier {
  articleId Int     @map("article_id")
  dossierId Int     @map("dossier_id")
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  dossier   Dossier @relation(fields: [dossierId], references: [id], onDelete: Cascade)

  @@id([articleId, dossierId])
  @@map("article_dossiers")
}

model CategoriePersonnalite {
  id            Int                              @id @default(autoincrement())
  slug          String                           @unique
  image         String?
  createdAt     DateTime                         @default(now()) @map("created_at")
  updatedAt     DateTime                         @updatedAt @map("updated_at")
  translations  CategoriePersonnaliteTranslation[]
  personnalites PersonnaliteCategory[]

  @@map("categories_personnalites")
}

model CategoriePersonnaliteTranslation {
  id          Int                   @id @default(autoincrement())
  categorieId Int                   @map("categorie_id")
  lang        String                @db.VarChar(2)
  nom         String
  description String                @db.Text
  categorie   CategoriePersonnalite @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  @@unique([categorieId, lang])
  @@map("categories_personnalites_translations")
}

model Personnalite {
  id          Int                    @id @default(autoincrement())
  slug        String                 @unique
  nom         String
  image       String?
  youtubeUrl  String?                @map("youtube_url")
  articleId   Int?                   @map("article_id")
  publishedAt DateTime?              @map("published_at")
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")
  article     Article?               @relation(fields: [articleId], references: [id], onDelete: SetNull)
  categories  PersonnaliteCategory[]

  @@map("personnalites")
}

model PersonnaliteCategory {
  personnaliteId Int                   @map("personnalite_id")
  categorieId    Int                   @map("categorie_id")
  personnalite   Personnalite          @relation(fields: [personnaliteId], references: [id], onDelete: Cascade)
  categorie      CategoriePersonnalite @relation(fields: [categorieId], references: [id], onDelete: Cascade)

  @@id([personnaliteId, categorieId])
  @@map("personnalite_categories")
}

model Redirect {
  id         Int      @id @default(autoincrement())
  oldPath    String   @unique @map("old_path") @db.VarChar(500)
  newPath    String   @map("new_path") @db.VarChar(500)
  entityType String   @map("entity_type") @db.VarChar(50)
  entityId   Int      @map("entity_id")
  hits       Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("redirects")
}

// Table contacts - source unique pour tous les emails
model Contact {
  id                 Int       @id @default(autoincrement())
  email              String    @unique @db.VarChar(255)
  name               String?   @db.VarChar(100)
  isSubscriber       Boolean   @default(false) @map("is_subscriber")
  subscribedAt       DateTime? @map("subscribed_at")
  subscriptionSource String?   @map("subscription_source") @db.VarChar(50)
  subscriptionStatus String?   @default("pending") @map("subscription_status") @db.VarChar(20)
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  comments           Comment[]

  @@map("contacts")
}

// DEPRECATED: Garder pour rétrocompatibilité, sera supprimé plus tard
model Subscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  source    String?  @db.VarChar(50)
  status    String   @default("pending") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("subscribers")
}
model Comment {
  id          Int       @id @default(autoincrement())
  articleId   Int       @map("article_id")
  contactId   Int?      @map("contact_id")
  parentId    Int?      @map("parent_id")
  memberId    Int?      @map("member_id")
  authorName  String    @map("author_name") @db.VarChar(100)
  authorEmail String    @map("author_email") @db.VarChar(255)
  content     String    @db.Text
  status      String    @default("pending") @db.VarChar(20)
  createdAt   DateTime  @default(now()) @map("created_at")
  article     Article   @relation(fields: [articleId], references: [id], onDelete: Cascade)
  contact     Contact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  member      Member?   @relation(fields: [memberId], references: [id], onDelete: SetNull)
  parent      Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[] @relation("CommentReplies")

  @@map("comments")
}

// =====================================================
// SYSTÈME COMMUNAUTÉ - MEMBRES
// =====================================================

// Membre de la communauté (différent de User qui est admin)
model Member {
  id                Int                @id @default(autoincrement())
  email             String             @unique @db.VarChar(255)
  passwordHash      String?            @map("password_hash") @db.VarChar(255)
  name              String             @db.VarChar(100)
  avatar            String?            @db.VarChar(500)
  bio               String?            @db.Text
  preferredLang     String             @default("fr") @map("preferred_lang") @db.VarChar(2)
  isEmailVerified   Boolean            @default(false) @map("is_email_verified")
  isSubscriber      Boolean            @default(false) @map("is_subscriber")
  lastLoginAt       DateTime?          @map("last_login_at")
  loginCount        Int                @default(0) @map("login_count")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  
  // Relations
  oauthAccounts     OAuthAccount[]
  emailVerifications EmailVerification[]
  passwordResets    PasswordReset[]
  favorites         MemberFavorite[]
  readingHistory    ReadingHistory[]
  comments          Comment[]
  sessions          MemberSession[]

  @@map("members")
}

// Sessions des membres (pour invalidation)
model MemberSession {
  id          String   @id @default(uuid()) @db.VarChar(36)
  memberId    Int      @map("member_id")
  token       String   @unique @db.VarChar(500)
  userAgent   String?  @map("user_agent") @db.VarChar(500)
  ipAddress   String?  @map("ip_address") @db.VarChar(45)
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  member      Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("member_sessions")
}

// Comptes OAuth (Google, Facebook)
model OAuthAccount {
  id           Int      @id @default(autoincrement())
  memberId     Int      @map("member_id")
  provider     String   @db.VarChar(20) // 'google' | 'facebook'
  providerId   String   @map("provider_id") @db.VarChar(255)
  accessToken  String?  @map("access_token") @db.Text
  refreshToken String?  @map("refresh_token") @db.Text
  expiresAt    DateTime? @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  member       Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@map("oauth_accounts")
}

// Vérification email
model EmailVerification {
  id        Int      @id @default(autoincrement())
  memberId  Int      @map("member_id")
  token     String   @unique @db.VarChar(100)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("email_verifications")
}

// Réinitialisation mot de passe
model PasswordReset {
  id        Int      @id @default(autoincrement())
  memberId  Int      @map("member_id")
  token     String   @unique @db.VarChar(100)
  expiresAt DateTime @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime @default(now()) @map("created_at")
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// Favoris des membres (persistants)
model MemberFavorite {
  memberId  Int      @map("member_id")
  articleId Int      @map("article_id")
  createdAt DateTime @default(now()) @map("created_at")
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@id([memberId, articleId])
  @@map("member_favorites")
}

// Historique de lecture
model ReadingHistory {
  id        Int      @id @default(autoincrement())
  memberId  Int      @map("member_id")
  articleId Int      @map("article_id")
  progress  Int      @default(0) // Pourcentage de lecture (0-100)
  readAt    DateTime @default(now()) @map("read_at")
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, articleId])
  @@map("reading_history")
}

// =====================================================
// UNE SEMAINE EN AFRIQUE - Actualités hebdomadaires
// =====================================================

// Édition hebdomadaire (une par semaine)
model WeeklyEdition {
  id           Int                        @id @default(autoincrement())
  weekNumber   Int                        @map("week_number")
  year         Int
  slug         String                     @unique
  publishedAt  DateTime?                  @map("published_at")
  createdAt    DateTime                   @default(now()) @map("created_at")
  updatedAt    DateTime                   @updatedAt @map("updated_at")
  translations WeeklyEditionTranslation[]
  news         WeeklyNews[]

  @@unique([year, weekNumber])
  @@map("weekly_editions")
}

// Traductions des éditions
model WeeklyEditionTranslation {
  id        Int           @id @default(autoincrement())
  editionId Int           @map("edition_id")
  lang      String        @db.VarChar(2)
  title     String
  summary   String?       @db.Text
  edition   WeeklyEdition @relation(fields: [editionId], references: [id], onDelete: Cascade)

  @@unique([editionId, lang])
  @@map("weekly_edition_translations")
}

// Actualités de la semaine (10 max par édition)
model WeeklyNews {
  id           Int                     @id @default(autoincrement())
  editionId    Int                     @map("edition_id")
  position     Int                     @default(1)
  country      String                  @db.VarChar(100)
  countryCode  String                  @map("country_code") @db.VarChar(2)
  sourceUrl    String?                 @map("source_url") @db.VarChar(500)
  sourceName   String?                 @map("source_name") @db.VarChar(100)
  createdAt    DateTime                @default(now()) @map("created_at")
  updatedAt    DateTime                @updatedAt @map("updated_at")
  edition      WeeklyEdition           @relation(fields: [editionId], references: [id], onDelete: Cascade)
  translations WeeklyNewsTranslation[]

  @@map("weekly_news")
}

// Traductions des actualités
model WeeklyNewsTranslation {
  id      Int        @id @default(autoincrement())
  newsId  Int        @map("news_id")
  lang    String     @db.VarChar(2)
  title   String     @db.VarChar(500)
  excerpt String     @db.Text
  news    WeeklyNews @relation(fields: [newsId], references: [id], onDelete: Cascade)

  @@unique([newsId, lang])
  @@map("weekly_news_translations")
}
